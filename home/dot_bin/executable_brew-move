#!/bin/bash
# brew-move: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ¥ã® Brewfile ã«ç§»å‹•

set -e

CHEZMOI_SOURCE="$HOME/.local/share/chezmoi/home"

echo "ğŸ“¦ Move package between Brewfiles"
echo ""

# fzf ãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if ! command -v fzf &> /dev/null; then
    echo "âŒ fzf is required but not installed"
    echo "   Install with: brew install fzf"
    exit 1
fi

# å…¨ Brewfile ã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§ã‚’å–å¾—ï¼ˆã‚½ãƒ¼ã‚¹æƒ…å ±ä»˜ãï¼‰
get_all_packages() {
    for file in common work personal; do
        filepath="$CHEZMOI_SOURCE/Brewfile.$file"
        if [ -f "$filepath" ]; then
            while IFS= read -r line; do
                if [[ $line =~ ^(brew|cask|mas) ]]; then
                    echo "[$file] $line"
                fi
            done < "$filepath"
        fi
    done
}

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ fzf ã§é¸æŠ
selected=$(get_all_packages | fzf --prompt="Select package to move: " --height=40% --reverse)

if [ -z "$selected" ]; then
    echo "âŒ No package selected"
    exit 1
fi

# é¸æŠã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æƒ…å ±ã‚’æŠ½å‡º
found_in=$(echo "$selected" | sed -E 's/^\[([^\]]+)\].*/\1/')
matching_line=$(echo "$selected" | sed -E 's/^\[[^\]]+\] (.*)/\1/')

echo ""
echo "Selected: $matching_line"
echo "From: Brewfile.$found_in"
echo ""

# ç§»å‹•å…ˆã‚’ fzf ã§é¸æŠï¼ˆç¾åœ¨ã®å ´æ‰€ã‚’é™¤å¤–ï¼‰
dest=$(printf "common\nwork\npersonal" | \
    grep -v "^$found_in$" | \
    fzf --prompt="Move to: " \
        --preview="echo 'common   - shared across all machines'; echo 'work     - work-specific packages'; echo 'personal - personal packages'" \
        --preview-window=up:3 \
        --height=40% \
        --reverse)

if [ -z "$dest" ]; then
    echo "âŒ No destination selected"
    exit 1
fi

# ç§»å‹•å®Ÿè¡Œ
source_path="$CHEZMOI_SOURCE/Brewfile.$found_in"
dest_path="$CHEZMOI_SOURCE/Brewfile.$dest"

# ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ grep ã§æ¤œç´¢
escaped_line=$(echo "$matching_line" | sed 's/[]\/$*.^[]/\\&/g')

# å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‰Šé™¤
grep -vF "$matching_line" "$source_path" > "$source_path.tmp"
mv "$source_path.tmp" "$source_path"

# ç§»å‹•å…ˆã«è¿½åŠ 
echo "$matching_line" >> "$dest_path"

echo ""
echo "âœ… Moved: $matching_line"
echo "   from: Brewfile.$found_in"
echo "   to:   Brewfile.$dest"

# chezmoi ã«åæ˜ 
echo ""
echo "ğŸ”„ Syncing to chezmoi..."
chezmoi re-add

echo ""
echo "ğŸ“ Next steps:"
echo "  cd ~/.local/share/chezmoi"
echo "  git diff"
echo "  git add . && git commit -m 'chore: move package to $dest' && git push"
